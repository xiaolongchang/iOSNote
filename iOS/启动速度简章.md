#iOS优化App启动速度

##前言

在如今互联网发展的今天，端之间的竞争愈演愈烈。移动端由原来的绝对优势，开始因为端测过重，需求量小等各种原因，市场份额被压缩。业务竞争的同时，如何保障体验感？是移动技术发展的趋势，App启动速度是起点也是重点，本文从三个方面来解析优化过程。


##一、APP启动原理
###1.1 名词解析

####冷启动：App启动前，系统中不存在当前App的进程。点击启动后，需要系统新创建一个进程分配给它，这个启动过程为冷启动。
####热启动：App冷启动后，用户手动把App切换至后台，系统中存在当前App的进程，当用户重新把App由后台切换唤醒至前台，这个切换唤醒的过程为热启动。

```
App启动速度的差异化主要表现在冷启动的方面，也是可操作的方面，本文也是以冷启动为切入点。
```


###1.2启动流程
####1.2.1 TapApp
####1.2.2 手机系统开辟内存空间
######1.2.2.1 系统根据PageZero-ASLR修改MACH-O文件中内容地址(可以增加被攻击难度)
######1.2.2.2 系统加载MACH-O文件到内存
#####1.2.3 启动DYLD进程
```
DYLD: the dynamic link edito 动态链接器
```
######1.2.3.1 DYLD 执行sMainExecutable = instantiateFromLoadedImage(....)加载可执行文件
######1.2.3.2 DYLD 执行loadInsertedDylib(...)加载动态库
######1.2.3.2 DYLD 生成ImageLoader类的镜像文件<待拓展>
######1.2.3.2 DYLD Rebase MACH-O文件内容指针，bind符号绑定
######1.2.3.2 DYLD 调用InitializeMainExecutable初始化，改初始化过程包含多个内容的初始化，依赖库初始化，runtime也是在该过程进行初始化
#####1.2.4 Runtime接手
######1.2.4.1 runtime 初始化相应依赖库里的类结构
######1.2.4.2 runtime 调用依赖库里所有的load方法
#####1.2.5 DYLD::main返回Main函数地址
#####1.2.6 Main函数被调用

#####1.2.7	首屏初始化所需配置文件读写操作
#####1.2.8	首屏数据读取操作
#####1.2.9	首屏渲染操作   

#####1.2.6 首屏渲染完成其他页面配置操作或数据读取、初始化等(不计入启动时间)


##二、如何获取启动时间
###2.1 分段获取时长 - pre-Main (main函数之前)
```
tips:per-main 阶段是系统操作，不能直接获取到时长，需要通过系统给出的信息来解析获取
```
####2.1.1 方式一：通过Xcode工具Time Profiler 获取
####2.1.2 方式二：通过更改环境变量打印 DYLD_PRINT_STATISTICS ：1
#####Tips：该方法适用于低版本手机和xcode上，高版本已失效
####2.1.2 方式三：通过获取进程创建（开始到结束）消耗的时间，以main入口为per-main结束点
```
__attribute__((constructor)) 可以将构建器函数的调用，作为per-mian结束点
```

###2.2 分段获取时长 - nex-Main (main函数之后)
####2.2.1 方式一：通过Xcode工具Time Profiler 获取
####2.2.2 方式二：通过hook objc_msgSend函数获取方法耗时，推荐库(fishhook)
```
fishhook 实现的大致思路是，通过重新绑定符号，可以实现对 c 方法的 hook。
dyld 是通过更新 Mach-O 二进制的 __DATA segment 特定的部分中的指针来
绑定 lazy 和 non-lazy 符号，通过确认传递给 rebind_symbol 里每个符号
名称更新的位置，就可以找出对应替换来重新绑定这些符号。
```


##三、如何优化启动速度

###3.1 优化速度 pre-Main 阶段

在 main() 函数执行前，系统主要会做下面几件事情：
######① 加载可执行文件（App 的.o 文件的集合）
######② 加载动态链接库，进行 rebase 指针调整和 bind 符号绑定
######③ Objc 运行时的初始处理，包括 Objc 相关类的注册、category 注册、selector 唯一性检查等；
######④ 初始化，包括了执行 +load() 方法、attribute((constructor)) 修饰的函数的调用、创建 C++ 静态全局变量。

####3.1.1 减少动态库加载，过多的动态库进行合并，苹果建议不超过6个非系统动态库
####3.1.2 减少启动后用不到的类和方法 
####3.1.3 控制 +load()方法的调用，使用+initialize()替换，或者逻辑上延后在初始化完成后

###3.2 优化速度 nex-Main 阶段
main() 函数执行后的阶段，指的是从 main() 函数执行开始，到 appDelegate 的 didFinishLaunchingWithOptions 方法里首屏渲染相关方法执行完成。
######① 首屏初始化所需配置文件的读写操作
######② 首屏列表大数据的读取
######③ 首屏渲染的大量计算等

####3.2.1 功能上梳理出，非首屏初始化需要操作，都做逻辑延后，或者业务处理

####3.2.2 更低层级的首屏UI渲染

####3.2.3 轻量级的数据获取与加工操作



##四、结语

未完待续...